<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>결제 준비</title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h2 {
            color: #2c3e50;
            text-align: center;
        }
        .payment-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
<section class="payment-form">
    <h2>결제하기</h2>
    <div class="form-group">
        <label for="token">인증 토큰:</label>
        <input type="text" id="token" placeholder="Bearer 토큰을 입력하세요" required />
    </div>
    <div class="form-group">
        <label for="customerEmail">서비스 이용자 이메일:</label>
        <input type="email" id="customerEmail" placeholder="이메일을 입력하세요" required />
    </div>
    <div class="form-group">
        <label for="payType">결제 타입:</label>
        <select id="payType" required>
            <option value="">선택하세요</option>
            <option value="CARD">카드</option>
            <option value="CASH">현금</option>
            <option value="POINT">포인트</option>
        </select>
    </div>
    <div class="form-group">
        <label for="amount">결제 금액:</label>
        <input type="number" id="amount" placeholder="금액을 입력하세요" required />
    </div>
    <div class="form-group">
        <label for="orderName">상품명:</label>
        <input type="text" id="orderName" placeholder="상품명을 입력하세요" required />
    </div>
    <div class="form-group">
        <label for="reservationId">예약 ID:</label>
        <input type="text" id="reservationId" placeholder="예약 ID를 입력하세요" required />
    </div>
    <div class="form-group">
        <label for="couponId">쿠폰 ID (선택):</label>
        <input type="text" id="couponId" placeholder="쿠폰 ID를 입력하세요" />
    </div>
    <button id="payment-button">결제하기</button>
</section>

<script>
    var button = document.getElementById('payment-button');

    // 페이지 로드 시 서버에서 clientKey를 가져오는 함수
    function getClientKey() {
        return fetch('/api/payments/client-key', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch client key');
                }
                return response.text();
            });
    }

    button.addEventListener('click', function () {
        var token = document.getElementById('token').value;
        var payType = document.getElementById('payType').value;
        var amount = parseInt(document.getElementById('amount').value, 10);
        var orderName = document.getElementById('orderName').value;
        var reservationId = document.getElementById('reservationId').value;
        var couponId = document.getElementById('couponId').value || null;
        var customerEmail = document.getElementById('customerEmail').value;

        // 이메일 형식 검사를 위한 정규표현식
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        // 입력 유효성 검사
        if (!token || !payType || isNaN(amount) || amount <= 0 || !orderName || !reservationId || !customerEmail) {
            alert('모든 필수 필드를 올바르게 입력해주세요.');
            return;
        }

        if (!emailRegex.test(customerEmail)) {
            alert('유효한 이메일 주소를 입력해주세요.');
            return;
        }

        // 서버에 결제 요청 전송
        fetch('/api/payments/toss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token.startsWith('Bearer ') ? token : 'Bearer ' + token
            },
            body: JSON.stringify({
                payType: payType,
                amount: amount,
                orderName: orderName,
                reservationId: reservationId,
                couponId: couponId,
                customerEmail: customerEmail
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || '서버 응답이 올바르지 않습니다.');
                    });
                }
                return response.json();  // JSON 응답을 반환
            })
            .then(data => {
                console.log('결제 요청 응답 데이터:', data);  // 응답 데이터를 로그로 출력

                return getClientKey()  // 서버에서 clientKey를 가져옴
                    .then(clientKey => {
                        var tossPayments = TossPayments(clientKey);

                        var paymentAmount = parseInt(data.amount, 10); // data.amount로 결제 금액을 설정
                        if (isNaN(paymentAmount) || paymentAmount <= 0) {
                            throw new Error('올바르지 않은 결제 금액입니다.');
                        }

                        // window.location.hostname을 사용하여 동적으로 URL 설정
                        var hostname = window.location.hostname;
                        var successUrl, failUrl;

                        if (hostname === 'localhost') {
                            // 로컬 개발 환경 URL
                            successUrl = "http://localhost:19096/api/payments/toss/success";
                            failUrl = "http://localhost:19096/api/payments/toss/fail";
                        } else {
                            // prod 환경 URL
                            successUrl = "http://13.209.24.74:19091/api/payments/toss/success";
                            failUrl = "http://13.209.24.74:19091/api/payments/toss/fail";
                        }

                        // 결제 요청
                        tossPayments.requestPayment(data.payType, {
                            amount: paymentAmount,
                            orderId: data.paymentId,  // reservationId 사용
                            orderName: orderName,
                            successUrl: successUrl,
                            failUrl: failUrl,
                        }).catch(function (error) {
                            if (error.code === "USER_CANCEL") {
                                // 결제 고객이 결제창을 닫았을 때 에러 처리
                                console.log("사용자가 결제를 취소했습니다.");
                                fetch(failUrl +"-cancel?code=" + error.code + "&message=" + error.message, {
                                    method: 'GET',
                                    headers: {
                                        'Authorization': token.startsWith('Bearer ') ? token : 'Bearer ' + token
                                    }
                                });
                            }
                        });
                    });
            })
            .catch(error => {
                console.error('결제 요청 중 오류:', error);
            });
    });
</script>
</body>
</html>