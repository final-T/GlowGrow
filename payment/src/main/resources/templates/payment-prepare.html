<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>결제</title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h2 {
            color: #2c3e50;
            text-align: center;
        }
        .payment-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
<section class="payment-form">
    <h2>결제하기</h2>
    <div class="form-group">
        <label for="token">인증 토큰:</label>
        <input type="text" id="token" placeholder="Bearer 토큰을 입력하세요" required />
    </div>
    <div class="form-group">
        <label for="customerId">서비스 이용자 ID:</label>
        <input type="text" id="customerId" th:value="${preparedPayment.customerId}" readonly />
    </div>
    <div class="form-group">
        <label for="userId">서비스 제공자 ID:</label>
        <input type="text" id="userId" th:value="${preparedPayment.userId}" readonly />
    </div>
    <div class="form-group">
        <label for="originalAmount">결제 금액:</label>
        <span id="originalAmount" th:text="${preparedPayment.amount}"></span>원
    </div>
    <div class="form-group discount-group" style="display:none;">
        <label>할인 금액:</label>
        <span id="discountAmount">0</span>원
    </div>
    <div class="form-group final-amount-group" style="display:none;">
        <label for="finalAmount">최종 결제 금액:</label>
        <span id="finalAmount" th:text="${preparedPayment.amount}"></span>원
    </div>
    <div class="form-group">
        <label for="orderName">상품명:</label>
        <input type="text" id="orderName" th:value="${preparedPayment.orderName}" readonly />
    </div>
    <div class="form-group">
        <label for="reservationId">예약 ID:</label>
        <input type="text" id="reservationId" th:value="${preparedPayment.reservationId}" readonly />
    </div>
    <div class="form-group">
        <label for="paymentId">결제 ID:</label>
        <input type="text" id="paymentId" th:value="${preparedPayment.paymentId}" readonly />
    </div>
    <div class="form-group">
        <label for="couponId">쿠폰 선택:</label>
        <button id="load-coupons-button">내 쿠폰 불러오기</button>
        <select id="couponId" style="display:none;">
            <option value="">쿠폰을 선택하세요</option>
        </select>
    </div>
    <button id="payment-button">결제하기</button>
</section>

<script th:inline="javascript">
    var button = document.getElementById('payment-button');
    var clientKey = /*[[${clientKey}]]*/ '';

    document.addEventListener('DOMContentLoaded', function() {
        var loadCouponsButton = document.getElementById('load-coupons-button');
        var couponSelect = document.getElementById('couponId');
        var originalAmountSpan = document.getElementById('originalAmount');
        var discountGroup = document.querySelector('.discount-group');
        var discountAmountSpan = document.getElementById('discountAmount');
        var finalAmountGroup = document.querySelector('.final-amount-group');
        var finalAmountSpan = document.getElementById('finalAmount');

        loadCouponsButton.addEventListener('click', function() {
            var token = document.getElementById('token').value;

            fetch(`/api/payments/user-coupons?reservationId=${document.getElementById('reservationId').value}`, {
                method: 'GET',
                headers: {
                    'Authorization': token.startsWith('Bearer ') ? token : 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(coupons => {
                    couponSelect.innerHTML = '<option value="">쿠폰을 선택하세요</option>';

                    // 서비스 제공자 ID 가져오기
                    var serviceProviderId = document.getElementById('userId').value;

                    coupons.forEach(coupon => {
                        var couponId = coupon.couponcode.split('-')[0]; // 쿠폰 코드에서 ID 추출

                        // 서비스 제공자 ID와 비교하여 일치하는 경우만 추가
                        if (couponId === serviceProviderId) {
                            var option = document.createElement('option');
                            option.value = coupon.couponId;
                            option.textContent = `${coupon.couponcode} - ${coupon.description} - ${coupon.discountValue}${coupon.discountType === 'PERCENTAGE' ? '%' : '원'} 할인 (${coupon.validFrom} ~ ${coupon.validUntil})`;
                            option.setAttribute('data-coupon', JSON.stringify(coupon));
                            couponSelect.appendChild(option);
                        }
                    });

                    loadCouponsButton.style.display = 'none';
                    couponSelect.style.display = 'block';
                })
                .catch(error => {
                    console.error('쿠폰 불러오기 오류:', error);
                    alert('쿠폰을 불러오는 데 실패했습니다.');
                });
        });

        couponSelect.addEventListener('change', function() {
            var selectedCoupon = couponSelect.options[couponSelect.selectedIndex];
            var originalAmount = parseFloat(originalAmountSpan.textContent);
            var discountAmount = 0;

            if (selectedCoupon.value !== "") {
                var couponData = JSON.parse(selectedCoupon.getAttribute('data-coupon'));

                if (couponData.discountType === 'PERCENTAGE') {
                    let calculatedDiscount = Math.round(originalAmount * (couponData.discountValue / 100.0));
                    let maxDiscountAmount = Math.round(originalAmount * (couponData.maxDiscount / 100.0));
                    discountAmount = Math.min(calculatedDiscount, maxDiscountAmount);
                } else {
                    discountAmount = Math.min(couponData.discountValue, originalAmount);
                }

                discountGroup.style.display = 'block';
                finalAmountGroup.style.display = 'block';
            } else {
                discountGroup.style.display = 'none';
                finalAmountGroup.style.display = 'none';
            }

            var finalAmount = originalAmount - discountAmount;

            discountAmountSpan.textContent = discountAmount;
            finalAmountSpan.textContent = finalAmount;
        });

        button.addEventListener('click', function () {
            var token = document.getElementById('token').value;
            var finalAmount = document.getElementById('finalAmount').style.display !== 'none'
                ? parseInt(document.getElementById('finalAmount').textContent)
                : parseInt(document.getElementById('originalAmount').textContent);

            var originalAmount = parseInt(document.getElementById('originalAmount').textContent);
            var discountAmount = parseInt(document.getElementById('discountAmount').textContent);

            var selectedCoupon = document.getElementById('couponId').selectedOptions[0];
            var couponData = selectedCoupon && selectedCoupon.value ? JSON.parse(selectedCoupon.getAttribute('data-coupon')) : null;



            var formData = {
                paymentId: document.getElementById('paymentId').value,
                amount: finalAmount,
                orderName: document.getElementById('orderName').value,
                reservationId: document.getElementById('reservationId').value,
                couponId: document.getElementById('couponId').value,
                originalAmount: originalAmount,
                discountAmount: discountAmount,
                couponcode: couponData ? couponData.couponcode : null, couponData
            };

            fetch('/api/payments/toss', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token.startsWith('Bearer ') ? token : 'Bearer ' + token
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || '서버 응답이 올바르지 않습니다.');
                        });
                    }
                    return response.json();
                })
                .then(data => {

                    var tossPayments = TossPayments(clientKey);

                    var hostname = window.location.hostname;
                    var successUrl, failUrl;

                    if (hostname === 'localhost') {
                        successUrl = "http://localhost:19096/api/payments/toss/success";
                        failUrl = "http://localhost:19096/api/payments/toss/fail";
                    } else {
                        successUrl = "http://13.209.24.74:19096/api/payments/toss/success";
                        failUrl = "http://13.209.24.74:19096/api/payments/toss/fail";
                    }

                    var tossPaymentData = {
                        amount: finalAmount,
                        orderId: formData.paymentId,
                        orderName: formData.orderName,
                        successUrl: successUrl,
                        failUrl: failUrl,
                        customerName: data.customerName
                    };

                    tossPayments.requestPayment(tossPaymentData)
                        .catch(function (error) {
                            if (error.code === "USER_CANCEL") {
                                console.log("사용자가 결제를 취소했습니다.");
                                fetch(failUrl + "-cancel?code=" + error.code + "&message=" + error.message, {
                                    method: 'GET',
                                    headers: {
                                        'Authorization': token.startsWith('Bearer ') ? token : 'Bearer ' + token
                                    }
                                });
                            }
                        });
                })
                .catch(error => {
                    console.error('결제 요청 중 오류:', error);
                });
        });
    });
</script>
</body>
</html>